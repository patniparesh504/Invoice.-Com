<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fast Invoice — Simple Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#0b74de;
      --muted:#666;
      --bg:#f6f8fb;
      --card:#fff;
      font-family: "Inter", system-ui, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#111;padding:20px}
    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .panel{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(15,20,30,0.06)}
    h2{margin:0 0 12px 0;font-size:18px}
    label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    input[type="text"], input[type="date"], input[type="number"], textarea, select{
      width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef;margin-top:6px;font-size:14px
    }
    .flex{display:flex;gap:10px}
    .items{margin-top:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th, td{padding:8px;text-align:left;border-bottom:1px solid #f0f2f6;font-size:14px}
    .right{text-align:right}
    button{background:var(--accent);color:#fff;padding:10px 12px;border:0;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .logo-preview{height:60px;object-fit:contain}
    /* invoice preview */
    .invoice{padding:18px;border-radius:8px;background:#fff;border:1px solid #eef2f7}
    .inv-head{display:flex;justify-content:space-between;align-items:center}
    .inv-head h3{margin:0}
    .inv-lines{margin-top:12px}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .danger{background:#e74c3c}
    @media(max-width:900px){.wrap{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Left: form -->
    <div class="panel">
      <h2>Invoice Data</h2>
      <label>Company name</label>
      <input id="companyName" type="text" value="Your Company Name">
      <label>Company address</label>
      <textarea id="companyAddress" rows="2">Address line 1, City, State, Pincode</textarea>

      <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
        <div style="flex:1">
          <label>Bill To (Customer)</label>
          <input id="billTo" type="text" value="Customer Name - City">
        </div>
        <div style="width:120px">
          <label>Invoice #</label>
          <input id="invoiceNo" type="text" value="INV-001">
        </div>
      </div>

      <div class="flex" style="margin-top:8px">
        <div style="flex:1">
          <label>Invoice Date</label>
          <input id="invoiceDate" type="date">
        </div>
        <div style="flex:1">
          <label>Due Date</label>
          <input id="dueDate" type="date">
        </div>
      </div>

      <label style="margin-top:12px">Logo (PNG/JPG)</label>
      <input id="logoInput" type="file" accept="image/*">
      <img id="logoPreview" class="logo-preview" alt="" style="display:none;margin-top:8px"/>

      <div class="items">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <label style="font-weight:600">Line items</label>
          <button id="addItemBtn" style="background:#2ecc71">+ Add item</button>
        </div>
        <table id="itemsTable">
          <thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th class="right">Amount</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="display:flex;justify-content:flex-end;margin-top:8px">
          <div style="width:250px">
            <div style="display:flex;justify-content:space-between"><div class="small">Subtotal</div><div id="subtotal" class="small">₹0</div></div>
            <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="small">Discount</div><div><input id="discount" type="number" value="0" min="0" style="width:100px"></div></div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;font-weight:700"><div>Total</div><div id="total">₹0</div></div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="downloadPdf">Download PDF</button>
        <button id="exportJson" style="background:#6c5ce7">Export JSON</button>
        <label style="display:inline-block;background:#f1f3f6;padding:8px;border-radius:8px;cursor:pointer;color:#333">
          Import JSON <input id="importJson" type="file" accept="application/json" style="display:none">
        </label>
        <button id="resetBtn" class="danger">Reset</button>
      </div>

      <p class="muted" style="margin-top:12px">Tip: Push this single file to GitHub and enable GitHub Pages (branch: main, folder: /) to host it free.</p>
    </div>

    <!-- Right: preview -->
    <div class="panel">
      <h2>Preview</h2>
      <div id="invoicePreview" class="invoice">
        <div class="inv-head">
          <div>
            <h3 id="p-company">Your Company Name</h3>
            <div id="p-address" class="small">Address line 1, City, State, Pincode</div>
          </div>
          <div style="text-align:right">
            <img id="p-logo" src="" alt="" class="logo-preview" style="display:none">
            <div style="margin-top:8px">
              <div><strong>Invoice</strong></div>
              <div class="small"># <span id="p-invoiceno">INV-001</span></div>
              <div class="small">Date: <span id="p-date"></span></div>
              <div class="small">Due: <span id="p-duedate"></span></div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Bill To</div>
          <div id="p-billto" style="font-weight:600">Customer Name - City</div>
        </div>

        <div class="inv-lines">
          <table id="p-table">
            <thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th class="right">Amount</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display:flex;justify-content:flex-end;margin-top:12px">
          <div style="width:260px">
            <div style="display:flex;justify-content:space-between"><div class="small">Subtotal</div><div id="p-sub">₹0</div></div>
            <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="small">Discount</div><div id="p-disc">₹0</div></div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;font-weight:700"><div>Total</div><div id="p-total">₹0</div></div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- Scripts -->
  <script>
    const q = sel => document.querySelector(sel);
    const qAll = sel => document.querySelectorAll(sel);
    const companyName = q('#companyName');
    const companyAddress = q('#companyAddress');
    const billTo = q('#billTo');
    const invoiceNo = q('#invoiceNo');
    const invoiceDate = q('#invoiceDate');
    const dueDate = q('#dueDate');
    const logoInput = q('#logoInput');
    const logoPreview = q('#logoPreview');
    const itemsTableBody = q('#itemsTable tbody');
    const p_company = q('#p-company');
    const p_address = q('#p-address');
    const p_billto = q('#p-billto');
    const p_invoiceno = q('#p-invoiceno');
    const p_date = q('#p-date');
    const p_duedate = q('#p-duedate');
    const p_table_body = q('#p-table tbody');
    const p_sub = q('#p-sub');
    const p_disc = q('#p-disc');
    const p_total = q('#p-total');
    const subtotalDisplay = q('#subtotal');
    const totalDisplay = q('#total');
    const discountInput = q('#discount');
    const today = new Date().toISOString().slice(0,10);
    invoiceDate.value = today;
    let items = [];

    function renderItems(){
      itemsTableBody.innerHTML = '';
      items.forEach((it, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input data-idx="${idx}" class="itm-name" type="text" value="${escapeHtml(it.name)}" style="width:100%"></td>
          <td><input data-idx="${idx}" class="itm-qty" type="number" min="0" value="${it.qty}" style="width:80px"></td>
          <td><input data-idx="${idx}" class="itm-rate" type="number" min="0" value="${it.rate}" style="width:100px"></td>
          <td class="right">₹${formatNumber(it.qty * it.rate)}</td>
          <td style="width:36px"><button data-idx="${idx}" class="del">✕</button></td>
        `;
        itemsTableBody.appendChild(tr);
      });
      p_table_body.innerHTML = '';
      items.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(it.name)}</td><td>${it.qty}</td><td>₹${formatNumber(it.rate)}</td><td class="right">₹${formatNumber(it.qty * it.rate)}</td>`;
        p_table_body.appendChild(tr);
      });
      attachItemEvents();
      recalc();
    }
    function attachItemEvents(){
      qAll('.del').forEach(btn=>{
        btn.onclick = e => {
          const idx = Number(e.target.dataset.idx);
          items.splice(idx,1);
          renderItems();
        };
      });
      qAll('.itm-name').forEach(inp=>{
        inp.oninput = e => { items[e.target.dataset.idx].name = e.target.value; renderItems(); };
      });
      qAll('.itm-qty').forEach(inp=>{
        inp.oninput = e => { items[e.target.dataset.idx].qty = Number(e.target.value)||0; renderItems(); };
      });
      qAll('.itm-rate').forEach(inp=>{
        inp.oninput = e => { items[e.target.dataset.idx].rate = Number(e.target.value)||0; renderItems(); };
      });
    }
    function recalc(){
      const subtotal = items.reduce((s,it)=>s + (it.qty * it.rate), 0);
      const discount = Number(discountInput.value) || 0;
      const total = Math.max(0, subtotal - discount);
      subtotalDisplay.textContent = `₹${formatNumber(subtotal)}`;
      totalDisplay.textContent = `₹${formatNumber(total)}`;
      p_sub.textContent = `₹${formatNumber(subtotal)}`;
      p_disc.textContent = `₹${formatNumber(discount)}`;
      p_total.textContent = `₹${formatNumber(total)}`;
    }
    function formatNumber(n){ return n.toLocaleString('en-IN', {maximumFractionDigits:2}); }
    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
    function addItem(name='',qty=1,rate=0){ items.push({name, qty:Number(qty)||0, rate:Number(rate)||0}); renderItems(); }
    addItem('Sample item',1,699);
    q('#addItemBtn').onclick = () => addItem('New item',1,0);
    [companyName, companyAddress, billTo, invoiceNo, invoiceDate, dueDate].forEach(el=>{
      el.oninput = updatePreview; el.onchange = updatePreview;
    });
    discountInput.oninput = recalc;
    function updatePreview(){
      p_company.textContent = companyName.value || 'Your Company Name';
      p_address.textContent = companyAddress.value || '';
      p_billto.textContent = billTo.value || '';
      p_invoiceno.textContent = invoiceNo.value || '';
      p_date.textContent = invoiceDate.value || '';
      p_duedate.textContent = dueDate.value || '';
    }
    updatePreview();
    logoInput.onchange = e => {
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ev => {
        logoPreview.src = ev.target.result; logoPreview.style.display = 'block';
        q('#p-logo').src = ev.target.result; q('#p-logo').style.display = 'block';
      };
      reader.readAsDataURL(f);
    };

    // UPDATED Download PDF function
    q('#downloadPdf').onclick = async () => {
      try {
        updatePreview(); recalc();
        const element = q('#invoicePreview');

        if (typeof html2canvas === 'undefined') {
          await new Promise((res, rej) => {
            const s = document.createElement('script');
            s.src = 'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js';
            s.onload = res; s.onerror = rej;
            document.head.appendChild(s);
          });
        }
        if (typeof window.jspdf === 'undefined' && typeof jsPDF === 'undefined') {
          await new Promise((res, rej) => {
            const s = document.createElement('script');
            s.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
            s.onload = res; s.onerror = rej;
            document.head.appendChild(s);
          });
        }

        const canvas = await html2canvas(element, { scale: 2, useCORS: true, scrollY: -window.scrollY });
        const imgData = canvas.toDataURL('image/jpeg', 0.95);

        const { jsPDF } = window.jspdf || window;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        const imgProps = await new Promise(res => {
          const img = new Image(); img.onload = () => res({ w: img.width, h: img.height }); img.src = imgData;
        });
        const ratio = Math.min(pageWidth / (imgProps.w * 0.264583), pageHeight / (imgProps.h * 0.264583));
        const imgWidthMM = imgProps.w * 0.264583 * ratio;
        const imgHeightMM = imgProps.h * 0.264583 * ratio;
        const x = (pageWidth - imgWidthMM) / 2;
        const y = 10;

        pdf.addImage(imgData, 'JPEG', x, y, imgWidthMM, imgHeightMM);
        pdf.save((invoiceNo.value || 'invoice') + '.pdf');
      } catch (err) {
        console.error('PDF generation failed', err);
        alert('PDF generation failed — Console માં Error ચેક કરો.');
      }
    };

    // export JSON
    q('#exportJson').onclick = () => {
      const payload = { companyName: companyName.value, companyAddress: companyAddress.value, billTo: billTo.value, invoiceNo: invoiceNo.value, invoiceDate: invoiceDate.value, dueDate: dueDate.value, items, discount: Number(discountInput.value)||0, logo: logoPreview.src || null };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = (invoiceNo.value || 'invoice') + '.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    };
    q('#importJson').onchange = e => {
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload
